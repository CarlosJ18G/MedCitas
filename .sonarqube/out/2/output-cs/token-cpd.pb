ç#
BC:\Users\Usuario\Desktop\medcitas\MedCitas\MedCitas.Web\Program.cs
var 
builder 
= 
WebApplication 
. 
CreateBuilder *
(* +
args+ /
)/ 0
;0 1
builder 
. 
Services 
. #
AddControllersWithViews (
(( )
)) *
;* +
builder 
. 
Services 
. 

AddSession 
( 
options #
=>$ &
{ 
options 
. 
IdleTimeout 
= 
TimeSpan "
." #
FromMinutes# .
(. /
$num/ 1
)1 2
;2 3
options 
. 
Cookie 
. 
HttpOnly 
= 
true "
;" #
options 
. 
Cookie 
. 
IsEssential 
=  
true! %
;% &
} 
) 
; 
var 

dbPassword 
= 
builder 
. 
Configuration &
[& '
$str' E
]E F
;F G
var  
baseConnectionString 
= 
builder "
." #
Configuration# 0
.0 1
GetConnectionString1 D
(D E
$strE X
)X Y
;Y Z
var 
connectionString 
= 
string 
. 
IsNullOrEmpty +
(+ ,

dbPassword, 6
)6 7
?  
baseConnectionString 
: 
$" 
{ 	 
baseConnectionString	 
} 
$str (
{( )

dbPassword) 3
}3 4
"4 5
;5 6

AppContext 

.
 
	SetSwitch 
( 
$str ;
,; <
false= B
)B C
;C D
builder!! 
.!! 
Services!! 
.!! 
AddDbContext!! 
<!! 
MedCitasDbContext!! /
>!!/ 0
(!!0 1
options!!1 8
=>!!9 ;
options"" 
."" 
	UseNpgsql"" 
("" 
connectionString"" &
)""& '
)""' (
;""( )
builder(( 
.(( 
Services(( 
.(( 
	AddScoped(( 
<(( 
IPacienteRepository(( .
,((. /!
EfPacienteRepositorio((0 E
>((E F
(((F G
)((G H
;((H I
builder)) 
.)) 
Services)) 
.)) 
	AddScoped)) 
<)) 
IEmailService)) (
,))( )
FakeEmailService))* :
>)): ;
()); <
)))< =
;))= >
builder** 
.** 
Services** 
.** 
	AddScoped** 
<** 
PacienteService** *
>*** +
(**+ ,
)**, -
;**- .
var// 
app// 
=// 	
builder//
 
.// 
Build// 
(// 
)// 
;// 
if44 
(44 
!44 
app44 
.44 	
Environment44	 
.44 
IsDevelopment44 "
(44" #
)44# $
)44$ %
{55 
app66 
.66 
UseExceptionHandler66 
(66 
$str66 )
)66) *
;66* +
app77 
.77 
UseHsts77 
(77 
)77 
;77 
}88 
app:: 
.:: 
UseHttpsRedirection:: 
(:: 
):: 
;:: 
app;; 
.;; 
UseStaticFiles;; 
(;; 
);; 
;;; 
app<< 
.<< 

UseRouting<< 
(<< 
)<< 
;<< 
app== 
.== 

UseSession== 
(== 
)== 
;== 
app>> 
.>> 
UseAuthorization>> 
(>> 
)>> 
;>> 
app@@ 
.@@ 
MapControllerRoute@@ 
(@@ 
nameAA 
:AA 	
$strAA
 
,AA 
patternBB 
:BB 
$strBB 5
)CC 
;CC 
awaitEE 
appEE 	
.EE	 

RunAsyncEE
 
(EE 
)EE 
;EE ·'
[C:\Users\Usuario\Desktop\medcitas\MedCitas\MedCitas.Web\Pages\Cuenta\VerificarOTP.cshtml.cs
	namespace 	
MedCitas
 
. 
Web 
. 
Pages 
. 
Cuenta #
{ 
public 

class 
VerificarOtpModel "
:# $
	PageModel% .
{		 
private

 
readonly

 
PacienteService

 (
_pacienteService

) 9
;

9 :
public 
VerificarOtpModel  
(  !
PacienteService! 0
pacienteService1 @
)@ A
{ 	
_pacienteService 
= 
pacienteService .
;. /
} 	
[ 	
BindProperty	 
] 
[ 	
Required	 
( 
ErrorMessage 
=  
$str! ;
); <
]< =
[ 	
EmailAddress	 
] 
public 
string 
Correo 
{ 
get "
;" #
set$ '
;' (
}) *
=+ ,
string- 3
.3 4
Empty4 9
;9 :
[ 	
BindProperty	 
] 
[ 	
Required	 
( 
ErrorMessage 
=  
$str! ?
)? @
]@ A
[ 	
RegularExpression	 
( 
$str %
,% &
ErrorMessage' 3
=4 5
$str6 V
)V W
]W X
public 
string 
	CodigoOTP 
{  !
get" %
;% &
set' *
;* +
}, -
=. /
string0 6
.6 7
Empty7 <
;< =
public 
string 
? 
Mensaje 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 
bool 
Exitoso 
{ 
get !
;! "
set# &
;& '
}( )
public 
void 
OnGet 
( 
string  
correo! '
)' (
{ 	
Correo   
=   
correo   
??   
string   %
.  % &
Empty  & +
;  + ,
}!! 	
public## 
async## 
Task## 
<## 
IActionResult## '
>##' (
OnPostAsync##) 4
(##4 5
)##5 6
{$$ 	
if%% 
(%% 
!%% 

ModelState%% 
.%% 
IsValid%% #
)%%# $
return&& 
Page&& 
(&& 
)&& 
;&& 
try(( 
{)) 
var** 

verificado** 
=**  
await**! &
_pacienteService**' 7
.**7 8
VerificarOTPAsync**8 I
(**I J
Correo**J P
,**P Q
	CodigoOTP**R [
)**[ \
;**\ ]
if,, 
(,, 

verificado,, 
),, 
{-- 
Mensaje.. 
=.. 
$str.. @
;..@ A
Exitoso// 
=// 
true// "
;//" #
return00 
RedirectToPage00 )
(00) *
$str00* 9
)009 :
;00: ;
}11 
else22 
{33 
Mensaje44 
=44 
$str44 ?
;44? @
Exitoso55 
=55 
false55 #
;55# $
}66 
}77 
catch88 
(88 
	Exception88 
ex88 
)88  
{99 
Mensaje:: 
=:: 
ex:: 
.:: 
Message:: $
;::$ %
Exitoso;; 
=;; 
false;; 
;;;  
}<< 
return>> 
Page>> 
(>> 
)>> 
;>> 
}?? 	
publicAA 
asyncAA 
TaskAA 
<AA 
IActionResultAA '
>AA' (
OnPostReenviarAsyncAA) <
(AA< =
)AA= >
{BB 	
tryCC 
{DD 
awaitEE 
_pacienteServiceEE &
.EE& '
ReenviarOTPAsyncEE' 7
(EE7 8
CorreoEE8 >
)EE> ?
;EE? @
MensajeFF 
=FF 
$strFF :
;FF: ;
ExitosoGG 
=GG 
trueGG 
;GG 
}HH 
catchII 
(II 
	ExceptionII 
exII 
)II  
{JJ 
MensajeKK 
=KK 
exKK 
.KK 
MessageKK $
;KK$ %
ExitosoLL 
=LL 
falseLL 
;LL  
}MM 
returnOO 
PageOO 
(OO 
)OO 
;OO 
}PP 	
}QQ 
}RR ¸
PC:\Users\Usuario\Desktop\medcitas\MedCitas\MedCitas.Web\Models\ErrorViewModel.cs
	namespace 	
MedCitas
 
. 
Web 
. 
Models 
; 
public 
class 
ErrorViewModel 
{ 
public 

string 
? 
	RequestId 
{ 
get "
;" #
set$ '
;' (
}) *
public 

bool 
ShowRequestId 
=>  
!! "
string" (
.( )
IsNullOrEmpty) 6
(6 7
	RequestId7 @
)@ A
;A B
} À[
YC:\Users\Usuario\Desktop\medcitas\MedCitas\MedCitas.Web\Controllers\PacienteController.cs
	namespace		 	
MedCitas		
 
.		 
Web		 
.		 
Controllers		 "
{

 
[ 
SuppressMessage 
( 
$str  
,  !
$str" )
,) *
Justification+ 8
=9 :
$str: Y
)Y Z
]Z [
public 

class 
PacienteController #
:$ %

Controller& 0
{ 
private 
readonly 
PacienteService (
_pacienteService) 9
;9 :
public 
PacienteController !
(! "
PacienteService" 1
pacienteService2 A
)A B
{ 	
_pacienteService 
= 
pacienteService .
;. /
} 	
[ 	
HttpGet	 
] 
public 
IActionResult 
Registro %
(% &
)& '
{ 	
return 
View 
( 
) 
; 
} 	
[## 	
HttpPost##	 
]## 
public$$ 
async$$ 
Task$$ 
<$$ 
IActionResult$$ '
>$$' (
Registro$$) 1
($$1 2
Paciente$$2 :
model$$; @
,$$@ A
string$$B H
password$$I Q
,$$Q R
string$$S Y
confirmarPassword$$Z k
)$$k l
{%% 	
try&& 
{'' 
if(( 
((( 
!(( 

ModelState(( 
.((  
IsValid((  '
)((' (
return)) 
View)) 
())  
model))  %
)))% &
;))& '
var++ 
nuevoPaciente++ !
=++" #
await++$ )
_pacienteService++* :
.++: ;
RegistrarAsync++; I
(++I J
model++J O
,++O P
password++Q Y
,++Y Z
confirmarPassword++[ l
)++l m
;++m n
TempData-- 
[-- 
$str-- "
]--" #
=--$ %
$"--& (
$str--( h
{--h i
nuevoPaciente--i v
.--v w
CorreoElectronico	--w 
}
-- 
"
-- 
;
-- 
TempData.. 
[.. 
$str.. +
]..+ ,
=..- .
nuevoPaciente../ <
...< =
CorreoElectronico..= N
;..N O
return00 
RedirectToAction00 '
(00' (
$str00( 6
)006 7
;007 8
}11 
catch22 
(22 
DbUpdateException22 $
dbEx22% )
)22) *
{33 
ViewBag55 
.55 
Error55 
=55 
$"55  "
$str55" /
{55/ 0
dbEx550 4
.554 5
InnerException555 C
?55C D
.55D E
Message55E L
??55M O
dbEx55P T
.55T U
Message55U \
}55\ ]
"55] ^
;55^ _
return66 
View66 
(66 
model66 !
)66! "
;66" #
}77 
catch88 
(88 
	Exception88 
ex88 
)88  
{99 
ViewBag:: 
.:: 
Error:: 
=:: 
$"::  "
$str::" )
{::) *
ex::* ,
.::, -
Message::- 4
}::4 5
"::5 6
;::6 7
if;; 
(;; 
ex;; 
.;; 
InnerException;; %
!=;;& (
null;;) -
);;- .
ViewBag<< 
.<< 
Error<< !
+=<<" $
$"<<% '
$str<<' 1
{<<1 2
ex<<2 4
.<<4 5
InnerException<<5 C
.<<C D
Message<<D K
}<<K L
"<<L M
;<<M N
return== 
View== 
(== 
model== !
)==! "
;==" #
}>> 
}?? 	
[DD 	
HttpGetDD	 
]DD 
publicEE 
IActionResultEE 
VerificarOTPEE )
(EE) *
)EE* +
{FF 	
ViewBagGG 
.GG 
CorreoGG 
=GG 
TempDataGG %
[GG% &
$strGG& 8
]GG8 9
?GG9 :
.GG: ;
ToStringGG; C
(GGC D
)GGD E
??GGF H
$strGGI K
;GGK L
ViewBagHH 
.HH 
MensajeHH 
=HH 
TempDataHH &
[HH& '
$strHH' 0
]HH0 1
?HH1 2
.HH2 3
ToStringHH3 ;
(HH; <
)HH< =
;HH= >
returnII 
ViewII 
(II 
)II 
;II 
}JJ 	
[OO 	
HttpPostOO	 
]OO 
publicPP 
asyncPP 
TaskPP 
<PP 
IActionResultPP '
>PP' (
VerificarOTPPP) 5
(PP5 6
stringPP6 <
correoPP= C
,PPC D
stringPPE K
	codigoOTPPPL U
)PPU V
{QQ 	
tryRR 
{SS 
varTT 
	resultadoTT 
=TT 
awaitTT  %
_pacienteServiceTT& 6
.TT6 7
VerificarOTPAsyncTT7 H
(TTH I
correoTTI O
,TTO P
	codigoOTPTTQ Z
)TTZ [
;TT[ \
ifVV 
(VV 
	resultadoVV 
)VV 
{WW 
TempDataXX 
[XX 
$strXX +
]XX+ ,
=XX- .
$strXX/ k
;XXk l
returnYY 
RedirectToActionYY +
(YY+ ,
$strYY, 3
)YY3 4
;YY4 5
}ZZ 
else[[ 
{\\ 
ViewBag]] 
.]] 
Error]] !
=]]" #
$str]]$ Y
;]]Y Z
ViewBag^^ 
.^^ 
Correo^^ "
=^^# $
correo^^% +
;^^+ ,
return__ 
View__ 
(__  
)__  !
;__! "
}`` 
}aa 
catchbb 
(bb 
	Exceptionbb 
exbb 
)bb  
{cc 
ViewBagdd 
.dd 
Errordd 
=dd 
exdd  "
.dd" #
Messagedd# *
;dd* +
ViewBagee 
.ee 
Correoee 
=ee  
correoee! '
;ee' (
returnff 
Viewff 
(ff 
)ff 
;ff 
}gg 
}hh 	
[mm 	
HttpPostmm	 
]mm 
publicnn 
asyncnn 
Tasknn 
<nn 
IActionResultnn '
>nn' (
ReenviarOTPnn) 4
(nn4 5
stringnn5 ;
correonn< B
)nnB C
{oo 	
trypp 
{qq 
awaitrr 
_pacienteServicerr &
.rr& '
ReenviarOTPAsyncrr' 7
(rr7 8
correorr8 >
)rr> ?
;rr? @
ViewBagss 
.ss 
Mensajess 
=ss  !
$strss" T
;ssT U
ViewBagtt 
.tt 
Correott 
=tt  
correott! '
;tt' (
returnuu 
Viewuu 
(uu 
$struu *
)uu* +
;uu+ ,
}vv 
catchww 
(ww 
	Exceptionww 
exww 
)ww  
{xx 
ViewBagyy 
.yy 
Erroryy 
=yy 
exyy  "
.yy" #
Messageyy# *
;yy* +
ViewBagzz 
.zz 
Correozz 
=zz  
correozz! '
;zz' (
return{{ 
View{{ 
({{ 
$str{{ *
){{* +
;{{+ ,
}|| 
}}} 	
[
 	
HttpGet
	 
]
 
public
 
IActionResult
 
Login
 "
(
" #
)
# $
{
 	
ViewBag
 
.
 
Mensaje
 
=
 
TempData
 &
[
& '
$str
' 5
]
5 6
?
6 7
.
7 8
ToString
8 @
(
@ A
)
A B
;
B C
return
 
View
 
(
 
)
 
;
 
}
 	
[
 	
HttpPost
	 
]
 
public
 
async
 
Task
 
<
 
IActionResult
 '
>
' (
Login
) .
(
. /
string
/ 5
correoElectronico
6 G
,
G H
string
I O
password
P X
)
X Y
{
 	
try
 
{
 
var
 
paciente
 
=
 
await
 $
_pacienteService
% 5
.
5 6

LoginAsync
6 @
(
@ A
correoElectronico
A R
,
R S
password
T \
)
\ ]
;
] ^
if
 
(
 
paciente
 
==
 
null
  $
)
$ %
{
 
ViewBag
 
.
 
Error
 !
=
" #
$str
$ ?
;
? @
return
 
View
 
(
  
)
  !
;
! "
}
 
HttpContext
 
.
 
Session
 #
.
# $
	SetString
$ -
(
- .
$str
. :
,
: ;
paciente
< D
.
D E
Id
E G
.
G H
ToString
H P
(
P Q
)
Q R
)
R S
;
S T
HttpContext
 
.
 
Session
 #
.
# $
	SetString
$ -
(
- .
$str
. >
,
> ?
paciente
@ H
.
H I
NombreCompleto
I W
)
W X
;
X Y
return
 
RedirectToAction
 '
(
' (
$str
( /
,
/ 0
$str
1 7
)
7 8
;
8 9
}
 
catch
 
(
 
	Exception
 
ex
 
)
  
{
 
ViewBag
   
.
   
Error
   
=
   
ex
    "
.
  " #
Message
  # *
;
  * +
return
¡¡ 
View
¡¡ 
(
¡¡ 
)
¡¡ 
;
¡¡ 
}
¢¢ 
}
££ 	
[
¨¨ 	
HttpGet
¨¨	 
]
¨¨ 
[
©© 	
Route
©©	 
(
©© 
$str
©© 1
)
©©1 2
]
©©2 3
public
ªª 
async
ªª 
Task
ªª 
<
ªª 
IActionResult
ªª '
>
ªª' (
VerificarCuenta
ªª) 8
(
ªª8 9
string
ªª9 ?
token
ªª@ E
)
ªªE F
{
«« 	
var
¬¬ 
result
¬¬ 
=
¬¬ 
await
¬¬ 
_pacienteService
¬¬ /
.
¬¬/ 0 
ActivarCuentaAsync
¬¬0 B
(
¬¬B C
token
¬¬C H
)
¬¬H I
;
¬¬I J
ViewBag
­­ 
.
­­ 
	Resultado
­­ 
=
­­ 
result
­­  &
?
­­' (
$str
­­) I
:
­­J K
$str
­­L h
;
­­h i
return
®® 
View
®® 
(
®® 
)
®® 
;
®® 
}
¯¯ 	
}
°° 
}±± É
UC:\Users\Usuario\Desktop\medcitas\MedCitas\MedCitas.Web\Controllers\HomeController.cs
	namespace 	
MedCitas
 
. 
Web 
. 
Controllers "
;" #
public 
class 
HomeController 
: 

Controller (
{ 
public		 

IActionResult		 
Index		 
(		 
)		  
{

 
return 
View 
( 
) 
; 
} 
public 

IActionResult 
Privacy  
(  !
)! "
{ 
return 
View 
( 
) 
; 
} 
[ 
ResponseCache 
( 
Duration 
= 
$num 
,  
Location! )
=* +!
ResponseCacheLocation, A
.A B
NoneB F
,F G
NoStoreH O
=P Q
trueR V
)V W
]W X
public 

IActionResult 
Error 
( 
)  
{ 
return 
View 
( 
new 
ErrorViewModel &
{' (
	RequestId) 2
=3 4
Activity5 =
.= >
Current> E
?E F
.F G
IdG I
??J L
HttpContextM X
.X Y
TraceIdentifierY h
}i j
)j k
;k l
} 
} 